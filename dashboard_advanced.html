<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Dashboard DIAAM</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- STYLES -->
<style>
    body {
        font-family: Arial, sans-serif;
        background: #f4f4f4;
        margin: 0;
        padding: 0;
    }

    header {
        background: #0a74da;
        color: white;
        padding: 15px 20px;
        font-size: 22px;
        text-align: center;
        font-weight: bold;
    }

    .container {
        padding: 15px;
    }

    .card {
        background: white;
        border-radius: 10px;
        padding: 15px;
        margin-bottom: 20px;
        box-shadow: 0px 2px 6px rgba(0,0,0,0.15);
    }

    /* FILTRES */
    #filters {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    select, input {
        padding: 10px;
        font-size: 16px;
        border-radius: 8px;
        width: 100%;
        border: 1px solid #ccc;
    }

    #applyFilters {
        background: #0a74da;
        padding: 12px;
        color: white;
        border-radius: 8px;
        text-align: center;
        font-size: 18px;
        font-weight: bold;
        cursor: pointer;
    }

    /* GRAPHIQUES */
    canvas {
        width: 100% !important;
        height: auto !important;
    }

    /* STATISTIQUES */
    .stats-grid {
        display: grid;
        gap: 10px;
        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
    }

    .stat-box {
        background: #fff;
        border-radius: 8px;
        padding: 15px;
        text-align: center;
        font-size: 18px;
        font-weight: bold;
        box-shadow: 0px 2px 4px rgba(0,0,0,0.1);
    }
</style>
</head>

<body>
<header>DIAAM â€” Dashboard Analytique</header>

<div class="container">

    <!-- ðŸ”µ FILTRES -->
    <div class="card">
        <h3>Filtres</h3>

        <div id="filters">
            <select id="clientFilter">
                <option value="">Tous les clients</option>
            </select>

            <select id="machineFilter">
                <option value="">Toutes les machines</option>
            </select>

            <input type="date" id="dateStart">
            <input type="date" id="dateEnd">

            <div id="applyFilters">Appliquer</div>
        </div>
    </div>

    <!-- ðŸ”µ STATISTIQUES -->
    <div class="card">
        <h3>Statistiques Globales</h3>

        <div class="stats-grid">
            <div class="stat-box" id="statTotal"></div>
            <div class="stat-box" id="statUnique"></div>
            <div class="stat-box" id="statCategories"></div>
        </div>
    </div>

    <!-- ðŸ”µ GRAPHIQUES -->
    <div class="card">
        <h3>RÃ©partition par catÃ©gories</h3>
        <canvas id="chartCategories"></canvas>
    </div>

    <div class="card">
        <h3>Produits les plus choisis</h3>
        <canvas id="chartProduits"></canvas>
    </div>

</div>

<!-- ðŸ”µ SUPABASE -->
<script type="module">

    // Import obligatoire
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

    // ðŸ”µ Chargement config.json
    let CONFIG = null;

    async function loadConfig() {
        try {
            const res = await fetch("config.json");
            CONFIG = await res.json();
        } catch (err) {
            console.error("Erreur config.json :", err);
        }
    }

    // Charge config AVANT Supabase
    await loadConfig();

    const supabase = createClient(CONFIG.supabase.url, CONFIG.supabase.anonKey);

    // -------------------------------------------------------------------
    // ðŸ”µ RÃ©cupÃ©ration des donnÃ©es depuis Supabase
    // -------------------------------------------------------------------

    async function loadData(filters = {}) {

        let query = supabase
            .from(CONFIG.dashboard.tableName)
            .select("*");

        if (filters.clientId) query.eq("client_id", filters.clientId);
        if (filters.machineId) query.eq("machine_id", filters.machineId);
        if (filters.dateStart) query.gte("created_at", filters.dateStart);
        if (filters.dateEnd) query.lte("created_at", filters.dateEnd + " 23:59:59");

        const { data, error } = await query;

        if (error) {
            console.error("Erreur chargement data :", error);
            return [];
        }
        return data;
    }

    // -------------------------------------------------------------------
    // ðŸ”µ Affichage des statistiques
    // -------------------------------------------------------------------

    function updateStats(data) {
        document.getElementById("statTotal").textContent =
            "Total rÃ©ponses : " + data.length;

        const uniqueQuestions = new Set(data.map(d => d.question));
        document.getElementById("statUnique").textContent =
            "Questions uniques : " + uniqueQuestions.size;

        const uniqueCategories = new Set(data.map(d => d.category));
        document.getElementById("statCategories").textContent =
            "CatÃ©gories : " + uniqueCategories.size;
    }

    // -------------------------------------------------------------------
    // ðŸ”µ Graphique CatÃ©gories (camembert)
    // -------------------------------------------------------------------

    let chartCategories = null;

    function drawChartCategories(data) {
        const ctx = document.getElementById("chartCategories");

        const counts = {};
        data.forEach(d => {
            counts[d.category] = (counts[d.category] || 0) + 1;
        });

        if (chartCategories) chartCategories.destroy();

        chartCategories = new Chart(ctx, {
            type: "pie",
            data: {
                labels: Object.keys(counts),
                datasets: [{
                    data: Object.values(counts)
                }]
            }
        });
    }

    // -------------------------------------------------------------------
    // ðŸ”µ Graphique Produits / Choix
    // -------------------------------------------------------------------

    let chartProduits = null;

    function drawChartProduits(data) {
        const ctx = document.getElementById("chartProduits");

        const counts = {};

        data.forEach(d => {
            const choices = [d.choice_1, d.choice_2, d.choice_3, d.choice_4, d.choice_5];
            choices.forEach(c => {
                if (c) counts[c] = (counts[c] || 0) + 1;
            });
        });

        if (chartProduits) chartProduits.destroy();

        chartProduits = new Chart(ctx, {
            type: "bar",
            data: {
                labels: Object.keys(counts),
                datasets: [{
                    data: Object.values(counts)
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false
            }
        });
    }

    // -------------------------------------------------------------------
    // ðŸ”µ Application des filtres
    // -------------------------------------------------------------------

    document.getElementById("applyFilters").onclick = async () => {

        const filters = {
            clientId: document.getElementById("clientFilter").value,
            machineId: document.getElementById("machineFilter").value,
            dateStart: document.getElementById("dateStart").value,
            dateEnd: document.getElementById("dateEnd").value
        };

        const data = await loadData(filters);

        updateStats(data);
        drawChartCategories(data);
        drawChartProduits(data);
    };

    // -------------------------------------------------------------------
    // ðŸ”µ Initialisation au chargement
    // -------------------------------------------------------------------

    (async () => {
        const data = await loadData();

        updateStats(data);
        drawChartCategories(data);
        drawChartProduits(data);
    })();

</script>

</body>
</html>

