<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>DIAAM Analytics Pro — Advanced</title>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
<!-- html2canvas for PDF export -->
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<!-- jsPDF for PDF export -->
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<!-- SheetJS for XLSX export -->
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<style>
  :root{
    --bg:#0f1724;
    --card:#0b1220;
    --muted:#94a3b8;
    --accent:#06b6d4;
    --glass: rgba(255,255,255,0.03);
  }
  html,body{height:100%;margin:0;font-family:Inter,system-ui,Arial;color:#e6eef8;background:linear-gradient(180deg,#071025 0%, #071a2a 80%);}
  .wrap{max-width:1300px;margin:14px auto;padding:14px}
  header{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  h1{margin:0;font-size:18px}
  .topbar{display:flex;align-items:center;gap:10px;margin-top:12px;flex-wrap:wrap}
  select,input,button{padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:var(--card);color:#e6eef8}
  .filters{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .kpis{display:flex;gap:12px;margin-top:12px;flex-wrap:wrap}
  .kpi{background:var(--glass);padding:12px;border-radius:10px;min-width:160px;box-shadow:0 6px 20px rgba(2,6,23,0.5)}
  .layout{display:grid;grid-template-columns:1fr 420px;gap:12px;margin-top:12px}
  .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:10px;padding:12px;box-shadow:0 8px 30px rgba(2,6,23,0.6)}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  canvas{width:100% !important;height:auto !important}
  .table-scroll{max-height:300px;overflow:auto;margin-top:8px}
  table{width:100%;border-collapse:collapse;color:#cbd5e1}
  th,td{padding:6px;border-bottom:1px solid rgba(255,255,255,0.03);font-size:13px}
  .controls {display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .btn {background:var(--accent);color:#042028;border:none;padding:8px 10px;border-radius:8px;cursor:pointer}
  .ghost {background:transparent;border:1px solid rgba(255,255,255,0.06)}
  .small {font-size:13px;color:var(--muted)}
  footer{margin-top:12px;color:var(--muted);font-size:13px}
  @media(max-width:1000px){ .layout{grid-template-columns:1fr} .grid2{grid-template-columns:1fr} }
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>DIAAM Analytics Pro — Advanced</h1>
      <div style="margin-left:auto;display:flex;gap:8px;align-items:center;">
        <div id="userBadge" class="small">Visiteur</div>
        <button id="btnTheme" class="ghost">Thème</button>
        <button id="btnLogin" class="ghost">Login</button>
      </div>
    </header>

    <div class="topbar">
      <div class="filters">
        <select id="clientFilter"><option value="">Tous clients</option></select>
        <select id="machineFilter"><option value="">Toutes machines</option></select>
        <select id="categoryFilter"><option value="">Toutes catégories</option></select>
        <select id="questionFilter"><option value="">Toutes questions</option></select>
        <input type="date" id="dateFrom"/>
        <input type="date" id="dateTo"/>
        <button id="applyFilters" class="btn">Appliquer</button>
      </div>

      <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
        <button id="btnRefresh" class="ghost">Rafraîchir</button>
        <button id="exportCSV" class="ghost">Export CSV</button>
        <button id="exportXLS" class="ghost">Export XLSX</button>
        <button id="exportPDF" class="ghost">Export PDF</button>
      </div>
    </div>

    <div class="kpis" id="kpis">
      <div class="kpi"><div class="small">Total réponses</div><div id="kpTotal" style="font-weight:700;font-size:20px">0</div></div>
      <div class="kpi"><div class="small">Clients</div><div id="kpClients" style="font-weight:700">0</div></div>
      <div class="kpi"><div class="small">Machines</div><div id="kpMachines" style="font-weight:700">0</div></div>
      <div class="kpi"><div class="small">Top produit</div><div id="kpTop" style="font-weight:700">—</div></div>
    </div>

    <div class="layout">
      <main>
        <div class="grid2">
          <div class="card">
            <h3 style="margin-top:0">Top produits (bar)</h3>
            <canvas id="chartTopProducts" height="200"></canvas>
          </div>
          <div class="card">
            <h3 style="margin-top:0">Répartition catégories (doughnut)</h3>
            <canvas id="chartCategories" height="200"></canvas>
          </div>
        </div>

        <div class="card" style="margin-top:12px">
          <h3 style="margin-top:0">Timeline — Réponses / jour</h3>
          <canvas id="chartTimeline" height="120"></canvas>
        </div>

        <div class="grid2" style="margin-top:12px">
          <div class="card">
            <h3 style="margin-top:0">Top machines</h3>
            <canvas id="chartMachines" height="200"></canvas>
          </div>
          <div class="card">
            <h3 style="margin-top:0">Heat (machines x catégories)</h3>
            <canvas id="chartHeat" height="200"></canvas>
          </div>
        </div>

        <div class="card" style="margin-top:12px">
          <h3 style="margin-top:0">Répartition par question (sélection)</h3>
          <canvas id="chartQuestion" height="160"></canvas>
        </div>
      </main>

      <aside>
        <div class="card">
          <h3 style="margin-top:0">Table (extraits)</h3>
          <div class="table-scroll">
            <table id="tbl">
              <thead><tr><th>Date</th><th>Client</th><th>Machine</th><th>Catégorie</th><th>Question</th><th>Choix</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

        <div class="card" style="margin-top:12px">
          <h3 style="margin-top:0">Filtres rapides</h3>
          <div style="display:flex;gap:8px;flex-wrap:wrap">
            <button id="last7" class="ghost">7j</button>
            <button id="last30" class="ghost">30j</button>
            <button id="thisMonth" class="ghost">Mois</button>
            <button id="all" class="ghost">Tous</button>
          </div>
        </div>
      </aside>
    </div>

    <footer class="small">DIAAM Analytics Pro — Advanced • Responsive & exports</footer>
  </div>

<!-- Main JS module -->
<script>
document.addEventListener("DOMContentLoaded", async () => {

    // ---------------- SUPABASE ----------------
    const SUPABASE_URL = "https://vawvmiosgslvykfqxffs.supabase.co";
    const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZhd3ZtaW9zZ3NsdnlrZnF4ZmZzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM5NjcxNTAsImV4cCI6MjA3OTU0MzE1MH0.T_q5fT1PCOt_pwEFdoKqePFYp7N4IXZSN1XA3HGG5v8";
    const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

    // ---------------- ELEMENTS FILTRES ----------------
    const clientSelect = document.getElementById("filter-client");
    const machineSelect = document.getElementById("filter-machine");
    const dateStart = document.getElementById("filter-start");
    const dateEnd = document.getElementById("filter-end");
    const applyBtn = document.getElementById("apply-filters");

    if (!clientSelect || !machineSelect) {
        console.error("Les champs filtres ne sont pas trouvés.");
        return;
    }

    // ---------------- LOAD INITIAL DATA ----------------
    async function fetchAll() {
        let query = supabase.from("survey_results").select("*");

        if (clientSelect.value)
            query = query.eq("client_id", clientSelect.value);

        if (machineSelect.value)
            query = query.eq("machine_id", machineSelect.value);

        if (dateStart.value)
            query = query.gte("created_at", dateStart.value);

        if (dateEnd.value)
            query = query.lte("created_at", dateEnd.value + "T23:59:59");

        const { data, error } = await query;

        if (error) {
            console.error("Erreur chargement :", error);
            return;
        }

        renderDashboard(data);
    }

    // ---------------- RENDER ----------------
    function renderDashboard(data) {
        console.log("Données filtrées :", data);
        // Graphiques, stats, etc...
    }

    // ---------------- ACTION FILTRES ----------------
    applyBtn.addEventListener("click", fetchAll);

    // Lancer au démarrage
    fetchAll();
});
</script>

</body>
</html>
