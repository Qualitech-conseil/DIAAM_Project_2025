<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>DIAAM Analytics — PRO Ultimate</title>

<!-- Dependencies (order matters) -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<!-- Supabase UMD -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.1/dist/umd/supabase.js"></script>

<style>
  :root{
    --bg-dark: linear-gradient(180deg,#08101a 0%, #071025 80%);
    --bg-light: linear-gradient(180deg,#f8fafc 0%, #eef2f7 100%);
    --card-dark: rgba(255,255,255,0.03);
    --card-light: rgba(2,6,23,0.03);
    --muted: #94a3b8;
    --accent: #6ad1c9; /* softer cyan */
    --accent-2: #a6b8ff; /* soft blue */
    --pastel-1: #9ad3bc;
    --pastel-2: #ffd6a5;
    --pastel-3: #c6b8ff;
    --radius: 12px;
    --max-canvas-height: 320px;
  }
  html,body{height:100%;margin:0;font-family:Inter,system-ui,Arial;background:var(--bg-dark);color:#e6eef8}
  .wrap{max-width:1200px;margin:12px auto;padding:14px}
  header{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  h1{margin:0;font-size:18px}
  /* glass cards */
  .card{
    background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    border: 1px solid rgba(255,255,255,0.04);
    backdrop-filter: blur(6px) saturate(120%);
    border-radius: var(--radius);
    padding:12px;
    box-shadow: 0 8px 30px rgba(2,6,23,0.45);
  }
  .topbar{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-top:12px}
  .filters{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  select,input,button{padding:8px;border-radius:10px;border:1px solid rgba(255,255,255,0.06);background:rgba(0,0,0,0.16);color:inherit}
  .btn {background:var(--accent);color:#042028;border:none;padding:8px 12px;border-radius:10px;cursor:pointer}
  .ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);padding:8px 10px;border-radius:10px;cursor:pointer}
  .kpis{display:flex;gap:12px;margin-top:12px;flex-wrap:wrap}
  .kpi{min-width:140px;padding:12px;border-radius:12px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border:1px solid rgba(255,255,255,0.02)}
  .layout{display:grid;grid-template-columns:1fr 380px;gap:12px;margin-top:12px}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  canvas{width:100% !important;height:auto !important;max-height:var(--max-canvas-height) !important}
  .table-scroll{max-height:360px;overflow:auto;margin-top:8px}
  table{width:100%;border-collapse:collapse;color:#cbd5e1}
  th,td{padding:6px;border-bottom:1px solid rgba(255,255,255,0.03);font-size:13px}
  .small{font-size:13px;color:var(--muted)}
  footer{margin-top:12px;color:var(--muted);font-size:13px}
  /* mobile adjustments */
  @media (max-width:900px){
    .layout{grid-template-columns:1fr}
    .grid2{grid-template-columns:1fr}
    :root{--max-canvas-height:220px}
    .table-scroll{max-height:220px}
    .filters{gap:6px}
    .kpi{min-width:110px;padding:10px}
  }
  /* light theme toggled */
  .light body, .light .wrap { color:#0b1220; }
  .light { background:var(--bg-light); color:#0b1220; }
  .light .card { background: rgba(255,255,255,0.92); border:1px solid rgba(2,6,23,0.06); box-shadow: 0 6px 18px rgba(2,6,23,0.06) }
  .light select,input,button{background:#fff;color:#0b1220;border:1px solid #e6eef8}
  /* pivot styles */
  .pivot-controls{display:flex;gap:6px;flex-wrap:wrap;align-items:center;margin-bottom:8px}
  .pivot-table{max-height:300px;overflow:auto;border:1px solid rgba(255,255,255,0.03);border-radius:8px;padding:6px;background:rgba(0,0,0,0.06)}
  .chip{padding:6px 8px;border-radius:8px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.03)}
</style>
</head>
<body>
  <div class="wrap" id="appWrap">
    <header>
      <h1>DIAAM Analytics — PRO Ultimate</h1>
      <div style="margin-left:auto;display:flex;gap:8px;align-items:center;">
        <div id="userBadge" class="small">Visiteur</div>
        <button id="btnTheme" class="ghost">Thème</button>
        <button id="btnLogin" class="ghost">Login</button>
      </div>
    </header>

    <div class="topbar">
      <div class="filters card" role="region" aria-label="Filtres">
        <select id="clientFilter" aria-label="Client"><option value="">Tous clients</option></select>
        <select id="machineFilter" aria-label="Machine"><option value="">Toutes machines</option></select>
        <select id="categoryFilter" aria-label="Catégorie"><option value="">Toutes catégories</option></select>
        <select id="questionFilter" aria-label="Question"><option value="">Toutes questions</option></select>
        <input type="date" id="dateFrom" aria-label="Date de"/>
        <input type="date" id="dateTo" aria-label="Date à"/>
        <button id="applyFilters" class="btn">Appliquer</button>
      </div>

      <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
        <button id="btnRefresh" class="ghost">Rafraîchir</button>
        <button id="exportCSV" class="ghost">Export CSV</button>
        <button id="exportXLS" class="ghost">Export XLSX</button>
        <button id="exportPDF" class="ghost">Export PDF</button>
      </div>
    </div>

    <div class="kpis" id="kpis">
      <div class="kpi card"><div class="small">Total réponses</div><div id="kpTotal" style="font-weight:700;font-size:20px">0</div></div>
      <div class="kpi card"><div class="small">Clients</div><div id="kpClients" style="font-weight:700">0</div></div>
      <div class="kpi card"><div class="small">Machines</div><div id="kpMachines" style="font-weight:700">0</div></div>
      <div class="kpi card"><div class="small">Top produit</div><div id="kpTop" style="font-weight:700">—</div></div>
    </div>

    <div style="margin-top:12px; display:flex; gap:8px; flex-wrap:wrap; align-items:center">
      <div class="chip">Période rapide :</div>
      <button id="btn7" class="ghost">7j</button>
      <button id="btn15" class="ghost">15j</button>
      <button id="btn30" class="ghost">30j</button>
      <button id="btn90" class="ghost">90j</button>
      <button id="btnMonth" class="ghost">Ce mois</button>
      <button id="btnAll" class="ghost">Tous</button>
    </div>

    <div class="layout" id="layoutArea">
      <main>
        <div class="grid2">
          <div class="card">
            <h3 style="margin-top:0">Top produits</h3>
            <canvas id="chartTopProducts" height="300" aria-label="Top produits"></canvas>
          </div>
          <div class="card">
            <h3 style="margin-top:0">Répartition catégories</h3>
            <canvas id="chartCategories" height="300" aria-label="Répartition catégories"></canvas>
          </div>
        </div>

        <div class="card" style="margin-top:12px">
          <h3 style="margin-top:0">Timeline — Réponses / jour</h3>
          <canvas id="chartTimeline" height="200" aria-label="Timeline"></canvas>
        </div>

        <div class="grid2" style="margin-top:12px">
          <div class="card">
            <h3 style="margin-top:0">Top machines</h3>
            <canvas id="chartMachines" height="260" aria-label="Top machines"></canvas>
          </div>
          <div class="card">
            <h3 style="margin-top:0">Heat (machines x catégories)</h3>
            <canvas id="chartHeat" height="260" aria-label="Heatmap"></canvas>
          </div>
        </div>

        <div class="card" style="margin-top:12px">
          <h3 style="margin-top:0">Répartition par question</h3>
          <canvas id="chartQuestion" height="220" aria-label="Questions"></canvas>
        </div>

        <div class="card" style="margin-top:12px">
          <h3 style="margin-top:0">Tableau croisé dynamique</h3>
          <div class="pivot-controls">
            <label>Rows<select id="pivotRows"><option value="category">Catégorie</option><option value="question">Question</option><option value="client_id">Client</option><option value="machine_id">Machine</option></select></label>
            <label>Columns<select id="pivotCols"><option value="question">Question</option><option value="category">Catégorie</option><option value="client_id">Client</option><option value="machine_id">Machine</option><option value="">(aucun)</option></select></label>
            <label>Value<select id="pivotValue"><option value="count">Count</option><option value="choice_1">Choice 1</option></select></label>
            <label>Agg<select id="pivotAgg"><option value="count">Count</option><option value="sum">Sum</option><option value="avg">Avg</option></select></label>
            <button id="pivotApply" class="btn">Appliquer pivot</button>
            <button id="pivotExport" class="ghost">Export pivot CSV</button>
          </div>
          <div class="pivot-table" id="pivotArea" role="table" aria-label="Pivot table"></div>
        </div>
      </main>

      <aside>
        <div class="card">
          <h3 style="margin-top:0">Table (extraits)</h3>
          <div class="table-scroll">
            <table id="tbl" aria-label="Tableau résultats">
              <thead><tr><th>Date</th><th>Client</th><th>Machine</th><th>Catégorie</th><th>Question</th><th>Choix</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

        <div class="card" style="margin-top:12px">
          <h3 style="margin-top:0">Actions</h3>
          <div style="display:flex;gap:8px;flex-wrap:wrap">
            <button id="exportCSV" class="ghost">Export CSV</button>
            <button id="exportXLS" class="ghost">Export XLSX</button>
            <button id="exportPDF" class="ghost">Export PDF</button>
            <button id="refreshBtn" class="ghost">Rafraîchir</button>
          </div>
        </div>
      </aside>
    </div>

    <footer class="small">DIAAM Analytics Pro — Ultimate • Soft colors • Pivot • Mobile</footer>
  </div>

<script>
/* ---------------- DOM ready ---------------- */
document.addEventListener("DOMContentLoaded", async () => {

  // --------- CONFIG ----------
  const SUPABASE_URL = "https://vawvmiosgslvykfqxffs.supabase.co";
  const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZhd3ZtaW9zZ3NsdnlrZnF4ZmZzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM5NjcxNTAsImV4cCI6MjA3OTU0MzE1MH0.T_q5fT1PCOt_pwEFdoKqePFYp7N4IXZSN1XA3HGG5v8"; // keep full key from your config
  const TABLE_NAME = "survey_results";

  // ensure supabase UMD is available
  if (!window.supabase || !window.supabase.createClient) {
    alert('Supabase SDK non chargé. Vérifier inclusion du script supabase.js.');
    return;
  }
  const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

  // --------- DOM refs ----------
  const clientFilter = document.getElementById('clientFilter');
  const machineFilter = document.getElementById('machineFilter');
  const categoryFilter = document.getElementById('categoryFilter');
  const questionFilter = document.getElementById('questionFilter');
  const dateFrom = document.getElementById('dateFrom');
  const dateTo = document.getElementById('dateTo');
  const applyBtn = document.getElementById('applyFilters');
  const btnRefresh = document.getElementById('btnRefresh');
  const btnExportCSV = document.querySelectorAll('#exportCSV');
  const btnExportXLS = document.querySelectorAll('#exportXLS');
  const btnExportPDF = document.querySelectorAll('#exportPDF');
  const btn7 = document.getElementById('btn7');
  const btn15 = document.getElementById('btn15');
  const btn30 = document.getElementById('btn30');
  const btn90 = document.getElementById('btn90');
  const btnMonth = document.getElementById('btnMonth');
  const btnAll = document.getElementById('btnAll');

  const kpTotal = document.getElementById('kpTotal');
  const kpClients = document.getElementById('kpClients');
  const kpMachines = document.getElementById('kpMachines');
  const kpTop = document.getElementById('kpTop');

  const tblBody = document.querySelector('#tbl tbody');

  const ctxTop = document.getElementById('chartTopProducts').getContext('2d');
  const ctxCat = document.getElementById('chartCategories').getContext('2d');
  const ctxTime = document.getElementById('chartTimeline').getContext('2d');
  const ctxMachines = document.getElementById('chartMachines').getContext('2d');
  const ctxHeat = document.getElementById('chartHeat').getContext('2d');
  const ctxQuestion = document.getElementById('chartQuestion').getContext('2d');

  // pivot refs
  const pivotRows = document.getElementById('pivotRows');
  const pivotCols = document.getElementById('pivotCols');
  const pivotValue = document.getElementById('pivotValue');
  const pivotAgg = document.getElementById('pivotAgg');
  const pivotApply = document.getElementById('pivotApply');
  const pivotArea = document.getElementById('pivotArea');
  const pivotExport = document.getElementById('pivotExport');

  // --------- state ----------
  let rows = []; let filtered = [];
  let charts = { top:null, cat:null, time:null, machines:null, heat:null, question:null };
  let lastQueryId = 0; // for concurrency safety

  // --------- helpers ----------
  const fmtDate = d => d ? new Date(d).toLocaleString() : '';
  const safe = v => v == null ? '' : v;
  function aggregateChoices(rs){
    const counts = {};
    rs.forEach(r=>{
      for(let i=1;i<=5;i++){
        const v = r[`choice_${i}`];
        if (v) counts[v] = (counts[v]||0) + 1;
      }
    });
    return Object.entries(counts).sort((a,b)=>b[1]-a[1]);
  }

  // colors pastel palette
  const palette = ['#9ad3bc','#ffd6a5','#c6b8ff','#bfe3ff','#f7c6c7','#d6e7c7','#f1e0ff'];

  // debounce util
  function debounce(fn, t=300){
    let to; return (...args)=>{ clearTimeout(to); to=setTimeout(()=>fn(...args), t); };
  }

  // --------- fetch data (safe, debounced) ----------
  async function fetchAll({limit=20000} = {}) {
    const qid = ++lastQueryId;
    document.getElementById('userBadge').innerText = 'Chargement...';
    try {
      const { data, error } = await sb
        .from(TABLE_NAME)
        .select('*')
        .order('created_at', { ascending: true })
        .limit(limit);

      if (qid !== lastQueryId) return; // stale
      if (error) { console.error(error); alert('Erreur Supabase: '+error.message); document.getElementById('userBadge').innerText='Erreur'; return; }
      rows = data || [];
      populateFilters();
      applyFilters();
      document.getElementById('userBadge').innerText = 'Visiteur';
    } catch (e){
      console.error(e); document.getElementById('userBadge').innerText = 'Erreur';
    }
  }
  const fetchAllDeb = debounce(fetchAll, 200);

  // --------- populate filters ----------
  function populateFilters(){
    const clients = Array.from(new Set(rows.map(r=>r.client_id).filter(Boolean))).sort();
    const machines = Array.from(new Set(rows.map(r=>r.machine_id).filter(Boolean))).sort();
    const cats = Array.from(new Set(rows.map(r=>r.category).filter(Boolean))).sort();
    const questions = Array.from(new Set(rows.map(r=>r.question).filter(Boolean))).sort();

    clientFilter.innerHTML = '<option value="">Tous clients</option>' + clients.map(c=>`<option value="${c}">${c}</option>`).join('');
    machineFilter.innerHTML = '<option value="">Toutes machines</option>' + machines.map(m=>`<option value="${m}">${m}</option>`).join('');
    categoryFilter.innerHTML = '<option value="">Toutes catégories</option>' + cats.map(c=>`<option value="${c}">${c}</option>`).join('');
    questionFilter.innerHTML = '<option value="">Toutes questions</option>' + questions.map(q=>`<option value="${q}">${q}</option>`).join('');

    // pivot selects: keep in sync
    const allFields = ['','category','question','client_id','machine_id'];
    pivotRows.innerHTML = allFields.map(f=>`<option value="${f}">${f||'(aucun)'}</option>`).join('');
    pivotCols.innerHTML = allFields.map(f=>`<option value="${f}">${f||'(aucun)'}</option>`).join('');
    pivotValue.innerHTML = `<option value="count">Count</option><option value="choice_1">Choice 1</option><option value="choice_2">Choice 2</option>`;
  }

  // --------- apply filters ----------
  function applyFilters(){
    filtered = rows.slice();
    const c = clientFilter.value; if(c) filtered = filtered.filter(r=> r.client_id === c);
    const m = machineFilter.value; if(m) filtered = filtered.filter(r=> r.machine_id === m);
    const cat = categoryFilter.value; if(cat) filtered = filtered.filter(r=> r.category === cat);
    const q = questionFilter.value; if(q) filtered = filtered.filter(r=> r.question === q);
    if (dateFrom.value) filtered = filtered.filter(r=> new Date(r.created_at) >= new Date(dateFrom.value + 'T00:00:00'));
    if (dateTo.value) filtered = filtered.filter(r=> new Date(r.created_at) <= new Date(dateTo.value + 'T23:59:59'));
    renderAll();
  }
  const applyFiltersDeb = debounce(applyFilters, 120);

  // --------- renderers ----------
  function renderKPIs(){
    kpTotal.innerText = filtered.length;
    kpClients.innerText = new Set(filtered.map(r=>r.client_id)).size;
    kpMachines.innerText = new Set(filtered.map(r=>r.machine_id)).size;
    const agg = aggregateChoices(filtered);
    kpTop.innerText = agg[0] ? `${agg[0][0]} (${agg[0][1]})` : '—';
  }

  function renderTable(limit=250){
    tblBody.innerHTML = '';
    filtered.slice().reverse().slice(0,limit).forEach(r=>{
      const choices = [r.choice_1,r.choice_2,r.choice_3,r.choice_4,r.choice_5].filter(Boolean).join(' | ');
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${fmtDate(r.created_at)}</td><td>${safe(r.client_id)}</td><td>${safe(r.machine_id)}</td><td>${safe(r.category)}</td><td>${safe(r.question)}</td><td>${safe(choices)}</td>`;
      tblBody.appendChild(tr);
    });
  }

  function destroyChart(ch){
    try { if (ch) { ch.destroy(); } } catch(e){ /* ignore */ }
  }

  function renderTopProducts(){
    const data = aggregateChoices(filtered).slice(0,20);
    const labels = data.map(d=>d[0]), vals = data.map(d=>d[1]);
    destroyChart(charts.top);
    charts.top = new Chart(ctxTop, {
      type:'bar',
      data:{ labels, datasets:[{ label:'Sélections', data:vals, backgroundColor: labels.map((_,i)=>palette[i%palette.length]) }]},
      options:{responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true}}}
    });
  }

  function renderCatChart(){
    const counts = {}; filtered.forEach(r=> counts[r.category] = (counts[r.category]||0)+1 );
    const labels = Object.keys(counts), data = Object.values(counts);
    destroyChart(charts.cat);
    charts.cat = new Chart(ctxCat, {
      type:'doughnut',
      data:{ labels, datasets:[{ data, backgroundColor: labels.map((_,i)=>palette[i%palette.length]) }]},
      options:{responsive:true, maintainAspectRatio:false}
    });
  }

  function renderTimeline(){
    const perDay = {};
    filtered.forEach(r=>{ if(!r.created_at) return; const d = new Date(r.created_at).toISOString().slice(0,10); perDay[d] = (perDay[d]||0)+1; });
    const labels = Object.keys(perDay).sort(), data = labels.map(l=>perDay[l]);
    destroyChart(charts.time);
    charts.time = new Chart(ctxTime, {
      type:'line',
      data:{ labels, datasets:[{ label:'Réponses', data, borderColor:palette[0], backgroundColor:'rgba(154,211,188,0.12)', fill:true }]},
      options:{responsive:true, maintainAspectRatio:false, scales:{y:{beginAtZero:true}}}
    });
  }

  function renderMachines(){
    const counts = {}; filtered.forEach(r=> counts[r.machine_id] = (counts[r.machine_id]||0)+1 );
    const data = Object.entries(counts).sort((a,b)=>b[1]-a[1]).slice(0,12);
    const labels = data.map(d=>d[0]), vals = data.map(d=>d[1]);
    destroyChart(charts.machines);
    charts.machines = new Chart(ctxMachines, { type:'bar', data:{ labels, datasets:[{ data:vals, backgroundColor: labels.map((_,i)=>palette[i%palette.length]) }]}, options:{responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true}}} });
  }

  function renderHeat(){
    const cats = Array.from(new Set(filtered.map(r=>r.category))).sort();
    const machines = Array.from(new Set(filtered.map(r=>r.machine_id))).sort();
    if (!cats.length || !machines.length) { destroyChart(charts.heat); charts.heat = null; return; }
    const datasets = cats.map((cat,i)=>({ label:cat, data: machines.map(m=> filtered.filter(r=> r.machine_id===m && r.category===cat).length), stack:'s', backgroundColor:palette[i%palette.length] }));
    destroyChart(charts.heat);
    charts.heat = new Chart(ctxHeat, { type:'bar', data:{ labels: machines, datasets }, options:{ indexAxis:'y', responsive:true, maintainAspectRatio:false, plugins:{legend:{position:'bottom'}} } });
  }

  function renderQuestionChart(){
    const counts = {}; filtered.forEach(r=>{ const k=r.question||'—'; counts[k]=(counts[k]||0)+1; });
    const labels = Object.keys(counts).sort((a,b)=>counts[b]-counts[a]).slice(0,12);
    const data = labels.map(l=>counts[l]);
    destroyChart(charts.question);
    charts.question = new Chart(ctxQuestion, { type:'polarArea', data:{ labels, datasets:[{ data, backgroundColor: labels.map((_,i)=>palette[i%palette.length]) }]}, options:{responsive:true, maintainAspectRatio:false} });
  }

  function renderAll(){
    renderKPIs(); renderTopProducts(); renderCatChart(); renderTimeline(); renderMachines(); renderHeat(); renderQuestionChart(); renderTable();
  }

  // --------- pivot table (client-side) ----------
  function buildPivot(){
    const rowField = pivotRows.value || null;
    const colField = pivotCols.value || null;
    const valField = pivotValue.value || 'count';
    const agg = pivotAgg.value || 'count';

    // build map: rowKey -> colKey -> values[]
    const map = new Map();
    const rowKeys = new Set(), colKeys = new Set();

    filtered.forEach(r=>{
      const rowKey = rowField ? (r[rowField] || '(vide)') : '(all)';
      const colKey = colField ? (r[colField] || '(vide)') : '(all)';
      rowKeys.add(rowKey); colKeys.add(colKey);
      const key = rowKey;
      if (!map.has(key)) map.set(key, new Map());
      const rowMap = map.get(key);
      if (!rowMap.has(colKey)) rowMap.set(colKey, []);
      const cell = rowMap.get(colKey);
      if (valField === 'count') cell.push(1);
      else cell.push(r[valField] || 0);
    });

    const rowsArr = Array.from(rowKeys).sort();
    const colsArr = Array.from(colKeys).sort();

    // compute aggregated values
    const table = [];
    rowsArr.forEach(rk=>{
      const rowMap = map.get(rk) || new Map();
      const rowObj = { row: rk, cells: {} };
      colsArr.forEach(ck=>{
        const vals = rowMap.get(ck) || [];
        let out = 0;
        if (agg === 'count') out = vals.length;
        else if (agg === 'sum') out = vals.reduce((a,b)=>a+b,0);
        else if (agg === 'avg') out = vals.length ? (vals.reduce((a,b)=>a+b,0)/vals.length) : 0;
        rowObj.cells[ck] = out;
      });
      table.push(rowObj);
    });

    // render HTML table
    let html = '<table style="width:100%;border-collapse:collapse;"><thead><tr><th>' + (rowField||'') + '</th>';
    colsArr.forEach(c=> html += `<th style="text-align:right">${c}</th>`);
    html += '</tr></thead><tbody>';
    table.forEach(r=>{
      html += `<tr><td style="font-weight:600">${r.row}</td>`;
      colsArr.forEach(c=> html += `<td style="text-align:right">${r.cells[c] || 0}</td>`);
      html += '</tr>';
    });
    html += '</tbody></table>';
    pivotArea.innerHTML = html;

    // store pivot for export
    pivotArea._pivot = { rowsArr, colsArr, table };
  }

  function exportPivotCSV(){
    const p = pivotArea._pivot;
    if (!p) return alert('Aucun pivot généré');
    const header = [pivotRows.value || '', ...p.colsArr];
    const rowsCsv = p.table.map(r => [r.row, ...p.colsArr.map(c=> r.cells[c] || 0)].map(v=>`"${v}"`).join(','));
    const csv = [header.map(h=>`"${h}"`).join(','), ...rowsCsv].join('\n');
    const blob = new Blob([csv], {type:'text/csv'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='pivot.csv'; a.click(); URL.revokeObjectURL(a.href);
  }

  // --------- exports ----------
  function exportCSV(){
    if (!filtered.length) return alert('Aucune donnée');
    const header = ['created_at','client_id','machine_id','category','question','choice_1','choice_2','choice_3','choice_4','choice_5'];
    const rowsCsv = filtered.map(r => header.map(h=> `"${(r[h]||'').toString().replace(/"/g,'""')}"`).join(','));
    const csv = [header.join(',')].concat(rowsCsv).join('\n');
    const blob = new Blob([csv], { type:'text/csv' }); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='export.csv'; a.click(); URL.revokeObjectURL(a.href);
  }

  function exportXLS(){
    if (!filtered.length) return alert('Aucune donnée');
    const wb = XLSX.utils.book_new();
    const header = ['created_at','client_id','machine_id','category','question','choice_1','choice_2','choice_3','choice_4','choice_5'];
    const data = [header].concat(filtered.map(r => header.map(h=> r[h] || '')));
    const ws = XLSX.utils.aoa_to_sheet(data);
    XLSX.utils.book_append_sheet(wb, ws, 'Export');
    XLSX.writeFile(wb, 'export.xlsx');
  }

  async function exportPDF(){
    if (!filtered.length) return alert('Aucune donnée');
    const area = document.getElementById('layoutArea');
    // choose scale to avoid "canvas too large" errors
    const scale = Math.min(1.0, window.devicePixelRatio || 1) * 0.9;
    const canvas = await html2canvas(area, { scale: scale, useCORS:true, logging:false, backgroundColor:null });
    const imgData = canvas.toDataURL('image/png');
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ orientation:'landscape', unit:'pt', format:'a4' });
    const pageW = doc.internal.pageSize.getWidth();
    const imgW = pageW - 40;
    const imgH = (canvas.height * imgW) / canvas.width;
    doc.addImage(imgData, 'PNG', 20, 20, imgW, imgH);
    doc.save('dashboard.pdf');
  }

  // --------- quick period helpers ----------
  function setRangeDays(d){
    const to = new Date(); const from = new Date(); from.setDate(to.getDate()-d);
    dateFrom.value = from.toISOString().slice(0,10); dateTo.value = to.toISOString().slice(0,10); applyFiltersDeb();
  }
  function setThisMonth(){
    const now = new Date(); dateFrom.value = new Date(now.getFullYear(), now.getMonth(), 1).toISOString().slice(0,10); dateTo.value = new Date(now.getFullYear(), now.getMonth()+1, 0).toISOString().slice(0,10); applyFiltersDeb();
  }
  function setAll(){ dateFrom.value=''; dateTo.value=''; clientFilter.value=''; machineFilter.value=''; categoryFilter.value=''; questionFilter.value=''; applyFiltersDeb(); }

  // --------- event wiring ----------
  applyBtn.addEventListener('click', applyFiltersDeb);
  btnRefresh.addEventListener('click', ()=> fetchAllDeb({limit:20000}));
  document.querySelectorAll('#exportCSV').forEach(b=>b.addEventListener('click', exportCSV));
  document.querySelectorAll('#exportXLS').forEach(b=>b.addEventListener('click', exportXLS));
  document.querySelectorAll('#exportPDF').forEach(b=>b.addEventListener('click', exportPDF));

  btn7.addEventListener('click', ()=> setRangeDays(7));
  btn15.addEventListener('click', ()=> setRangeDays(15));
  btn30.addEventListener('click', ()=> setRangeDays(30));
  btn90.addEventListener('click', ()=> setRangeDays(90));
  btnMonth.addEventListener('click', setThisMonth);
  btnAll.addEventListener('click', setAll);

  pivotApply.addEventListener('click', buildPivot);
  pivotExport.addEventListener('click', exportPivotCSV);

  // theme toggle
  document.getElementById('btnTheme').addEventListener('click', ()=> document.getElementById('appWrap').classList.toggle('light'));

  // login stub
  document.getElementById('btnLogin').addEventListener('click', async ()=>{
    const email = prompt('Email admin:'); if(!email) return;
    const pass = prompt('Mot de passe:'); if(!pass) return;
    try {
      const res = await sb.auth.signInWithPassword({ email, password: pass });
      if (res.error) { alert('Erreur login: '+res.error.message); return; }
      document.getElementById('userBadge').innerText = email;
      alert('Connecté');
    } catch(e){ console.error(e); alert('Erreur auth'); }
  });

  // initial load
  await fetchAllDeb({limit:20000});

}); // DOMContentLoaded
</script>
</body>
</html>

</html>


