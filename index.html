<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Formulaire Sondage</title>
    <link rel="stylesheet" href="style.css" />

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body>
    <div id="app">
        <img id="client-logo" src="" alt="Logo"
             style="max-width:150px; display:block; margin:0 auto 20px;" />

        <h1 id="form-title">Chargement...</h1>

        <form id="survey-form"></form>

        <button id="submit-btn" style="display:none; margin-top:20px;">Envoyer</button>

        <p id="status"></p>
    </div>

    <script>
        const params = new URLSearchParams(window.location.search);
        const clientId = params.get("client");
        const machineId = params.get("machine");

        const SUPABASE_URL = "https://vawvmiosgslvykfqxffs.supabase.co";
        const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZhd3ZtaW9zZ3NsdnlrZnF4ZmZzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM5NjcxNTAsImV4cCI6MjA3OTU0MzE1MH0.T_q5fT1PCOt_pwEFdoKqePFYp7N4IXZSN1XA3HGG5v8";

        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON);
        let CONFIG = null;

        async function loadConfig() {
            const response = await fetch(`clients/${clientId}/config.json`);
            CONFIG = await response.json();

            document.getElementById("client-logo").src = CONFIG.logo;
            document.getElementById("form-title").innerText = CONFIG.title;

            buildForm(CONFIG.categories);
            document.getElementById("submit-btn").style.display = "block";
        }

        function buildForm(categories) {
            const form = document.getElementById("survey-form");
            form.innerHTML = "";

            categories.forEach(cat => {
                const block = document.createElement("div");
                block.className = "category";
                block.dataset.category = cat.id;

                const title = document.createElement("h3");
                title.innerText = cat.question;
                block.appendChild(title);

                cat.options.forEach(opt => {
                    const div = document.createElement("div");
                    div.innerHTML = `
                        <label>
                            <input type="checkbox" name="${cat.id}" value="${opt}"> ${opt}
                        </label>`;
                    block.appendChild(div);
                });

                const other = document.createElement("div");
                other.innerHTML = `
                    <label>
                        <input type="checkbox" name="${cat.id}" value="Autre"> Autre
                    </label>
                    <input type="text" id="other-${cat.id}" style="display:none" placeholder="Précisez">
                `;
                block.appendChild(other);

                form.appendChild(block);
            });

            document.querySelectorAll("input[type='checkbox']").forEach(cb => {
                cb.addEventListener("change", () => {
                    if (cb.value === "Autre") {
                        const input = document.getElementById(`other-${cb.name}`);
                        input.style.display = cb.checked ? "inline-block" : "none";
                    }
                });
            });
        }

        async function submitForm() {
            const status = document.getElementById("status");
            status.innerText = "";

            for (const cat of CONFIG.categories) {
                const block = document.querySelector(`[data-category="${cat.id}"]`);
                const selected = [...block.querySelectorAll("input[type=checkbox]:checked")].map(x => x.value);

                let otherValue = null;
                if (selected.includes("Autre")) {
                    otherValue = document.getElementById(`other-${cat.id}`).value;
                }

                const finalChoices = selected.filter(x => x !== "Autre");
                if (otherValue) finalChoices.push(otherValue);

                // Pad to 5 cols
                const padded = [
                    finalChoices[0] || null,
                    finalChoices[1] || null,
                    finalChoices[2] || null,
                    finalChoices[3] || null,
                    finalChoices[4] || null
                ];

                await supabaseClient.from("survey_results").insert({
                    client_id: clientId,
                    machine_id: machineId,
                    category: cat.id,
                    question: cat.question,
                    choice_1: padded[0],
                    choice_2: padded[1],
                    choice_3: padded[2],
                    choice_4: padded[3],
                    choice_5: padded[4],
                    created_at: new Date().toISOString()
                });
            }

            status.innerText = "Merci, vos réponses ont été enregistrées.";
            document.getElementById("submit-btn").disabled = true;
        }

        document.getElementById("submit-btn").addEventListener("click", submitForm);
        loadConfig();
    </script>
</body>
</html>

</body>
</html>

